<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Comisiones de Terminales de Venta</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin-top: 20px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .terminal-logo { width: 40px; height: 40px; margin-right: 10px; }
        .result-item { margin-bottom: 15px; }
        .net-amount { margin-left: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Calculadora de Comisiones de Terminales de Venta</h1>

        <div class="mb-3">
            <label for="amount" class="form-label"><strong>Ingresa la cantidad a cobrar</strong></label>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="amount" placeholder="Ej: 1000" step="0.01">
                <button class="btn btn-success" onclick="calculate()">Calcular</button>
            </div>
        </div>

        <div id="results" class="mt-4"></div>

        <div class="mt-4 d-flex justify-content-between">
            <button id="shareBtn" class="btn btn-primary" style="display:none;" onclick="shareResults()">Compartir por WhatsApp</button>
            <button id="downloadBtn" class="btn btn-secondary" style="display:none;">Descargar PDF</button>
        </div>

        <div class="mt-4">
            <h2 class="text-center">Historial de Cálculos</h2>
            <ul id="historyList" class="list-group"></ul>
            <button class="btn btn-danger mt-2" onclick="clearHistory()">Limpiar Historial</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let providers = [];
        const logoUrls = {
            'Mercado Pago': './logos/mercado_pago.png',
            'Clip': './logos/clip.png',
            'Uala Bis': './logos/uala_bis.png',
            'Zettle': './logos/zettle.png',
            'Billpocket': './logos/billpocket.png',
            'KIWI': './logos/kiwi.png',
            'Sr. Pago de Konfio': './logos/konfio.png',
            'BBVA': './logos/bbva.png',
            'Banorte': './logos/banorte.png',
            'Acepta (Banamex)': './logos/banamex.png'
        };

        // Cargar datos desde el CSV de Google Sheets
        Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vS0w-nnrjf2F8vsc_Gyj43VPOcehhksNQin18rrUrTaz7sU7gN91MQBceO-eu8zehgEtNfF6gB-SY2F/pub?gid=528550114&single=true&output=csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.errors.length > 0) {
                    console.error('Errores al parsear el CSV:', results.errors);
                    alert('Error al cargar el archivo de comisiones.');
                    return;
                }
                providers = results.data.map(row => ({
                    name: row.Terminal || '',
                    commission: row['Comisión'] || '0'
                })).filter(p => p.name && p.commission);
                if (providers.length === 0) {
                    alert('No se encontraron datos válidos en el CSV.');
                }
                loadHistory();
            },
            error: function(error) {
                console.error('Error al cargar el CSV:', error);
                alert('Error al cargar el archivo de comisiones.');
            }
        });

        function calculate() {
            const amount = parseFloat(document.getElementById('amount').value);
            const resultsDiv = document.getElementById('results');
            const shareBtn = document.getElementById('shareBtn');
            const downloadBtn = document.getElementById('downloadBtn');

            if (isNaN(amount) || amount <= 0) {
                resultsDiv.innerHTML = '<div class="alert alert-danger">Por favor, ingresa un monto válido mayor a $0.</div>';
                shareBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                return;
            }

            if (providers.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-warning">Los datos de las comisiones aún no están disponibles.</div>';
                shareBtn.style.display = 'none';
                downloadBtn.style.display = 'none';
                return;
            }

            let resultsHtml = '<h2 class="text-center">Resultados:</h2>';
            const resultsData = [];
            providers.forEach(provider => {
                const commission = provider.commission;
                let commissionValue;
                if (commission.includes('-')) {
                    const [min, max] = commission.split('-').map(v => parseFloat(v.trim()));
                    commissionValue = (min + max) / 2;
                } else {
                    commissionValue = parseFloat(commission);
                }
                const commissionAmount = amount * commissionValue;
                const iva = commissionAmount * 0.16;
                const totalCommission = commissionAmount + iva;
                const netAmount = amount - totalCommission;

                resultsHtml += `
                    <div class="card result-item">
                        <div class="card-body d-flex align-items-center">
                            <img src="${logoUrls[provider.name] || ''}" class="terminal-logo" alt="${provider.name} logo">
                            <div class="result-details">
                                <div>
                                    <strong>${provider.name}:</strong><br>
                                    Comisión: $${commissionAmount.toFixed(2)}<br>
                                    IVA: $${iva.toFixed(2)}<br>
                                    Comisión total: $${totalCommission.toFixed(2)}<br>
                                </div>
                            </div>
                            <div class="net-amount net">
                                <strong>Monto neto:</strong><br>$${netAmount.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
                resultsData.push({
                    name: provider.name,
                    commission: commissionAmount.toFixed(2),
                    iva: iva.toFixed(2),
                    total: totalCommission.toFixed(2),
                    net: netAmount.toFixed(2)
                });
            });

            resultsDiv.innerHTML = resultsHtml;
            shareBtn.style.display = 'block';
            downloadBtn.style.display = 'block';

            const timestamp = new Date().toLocaleString();
            const historyEntry = { amount, results: resultsData, timestamp };
            saveToHistory(historyEntry);
            loadHistory();

            downloadBtn.onclick = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFont('Helvetica');
                doc.setFontSize(16);
                doc.text('Calculadora de Comisiones', 20, 20);
                doc.setFontSize(12);
                doc.text(`Monto: $${amount}`, 20, 30);
                let y = 40;
                resultsData.forEach(result => {
                    doc.addImage(logoUrls[result.name] || '', 'PNG', 20, y, 10, 10);
                    doc.text(`${result.name}:`, 35, y + 5);
                    y += 5;
                    doc.text(`Comisión: $${result.commission}`, 35, y);
                    y += 5;
                    doc.text(`IVA: $${result.iva}`, 35, y);
                    y += 5;
                    doc.text(`Total: $${result.total}`, 35, y);
                    y += 5;
                    doc.text(`Neto: $${result.net}`, 35, y);
                    y += 15;
                });
                doc.save(`Resultados_${timestamp.replace(/[, :]/g, '-')}.pdf`);
            };
        }

        function shareResults() {
            const amount = document.getElementById('amount').value;
            const timestamp = new Date().toLocaleString();
            const resultsData = providers.map(provider => {
                const commission = provider.commission.includes('-') ? 
                    ((parseFloat(provider.commission.split('-')[0]) + parseFloat(provider.commission.split('-')[1])) / 2) : 
                    parseFloat(provider.commission);
                const commissionAmount = amount * commission;
                const iva = commissionAmount * 0.16;
                const total = commissionAmount + iva;
                const net = amount - total;
                return `${provider.name}: Comisión: $${commissionAmount.toFixed(2)}, IVA: $${iva.toFixed(2)}, Total: $${total.toFixed(2)}, Neto: $${net.toFixed(2)}`;
            }).join('\n');
            const message = `Resultados para $${amount} (${timestamp}):\n${resultsData}`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`, '_blank');
        }

        function saveToHistory(entry) {
            let history = JSON.parse(localStorage.getItem('commissionHistory') || '[]');
            history.unshift(entry);
            localStorage.setItem('commissionHistory', JSON.stringify(history));
        }

        function loadHistory() {
            const historyList = document.getElementById('historyList');
            let history = JSON.parse(localStorage.getItem('commissionHistory') || '[]');
            historyList.innerHTML = history.map((entry, index) => `
                <li class="list-group-item">
                    Cálculo #${index + 1} - $${entry.amount} (${entry.timestamp})<br>
                    ${entry.results.map(r => `${r.name}: Neto: $${r.net}`).join('<br>')}
                </li>
            `).join('');
        }

        function clearHistory() {
            localStorage.removeItem('commissionHistory');
            loadHistory();
        }
    </script>
</body>
</html>
